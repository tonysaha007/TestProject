pipeline { 
    agent any 
    
	tools {
		maven 'maven-3.9.11' //Check the version in Jenkins Global Tool Configuration
		
	}

	environment {
		COMPOSE_PATH = "${WORKSPACE}/${PROJECT_FOLDER}/docker" // üîÅ Adjust if compose file is elsewhere
        SELENIUM_GRID = "true"
        GitHub_REPO = "https://github.com/tonysaha007/TestProject.git"
        PROJECT_FOLDER = "Web-Automation-Framework" // ${PROJECT_FOLDER}
        EMAIL_TO = "tony.ez007@gmail.com"
        
       	// https://github.com/*********.git // ${WORKSPACE}
		//	‚îÇ
		//	‚îú‚îÄ‚îÄ Project Folder Name // ${PROJECT_FOLDER}
		//	‚îÇ   ‚îú‚îÄ‚îÄ pom.xml
		//
	} 
	    
    stages {

		stage('Environment Setup') {

		    	steps {
	                script {
						echo "checking installed versions..."
						bat 'docker --version'
						bat 'docker compose version'
						bat 'mvn -version'
						bat 'java -version'
	                    bat "docker compose -f ${COMPOSE_PATH}\\docker-compose.yml up -d"
	                    echo "Waiting for Selenium Grid to be ready..."
	                    sleep 10 // Add a wait if needed
	                    echo "Environment setup complete. COMPOSE_PATH set to ${COMPOSE_PATH}"
	                }
            	}
	    }
	    	
        stage('Checkout Repository') {
            steps {
                git branch: 'master', url: "${GitHub_REPO}" // üîÅ Adjust per git repo
            }
        }

        stage('Build') {
            steps {
				dir("${PROJECT_FOLDER}") { // üîÅ Adjust per git repo
					bat 'mvn clean install -f pom.xml' 
				}
                
            }
        }

        stage('Test') {
            steps {
				dir("${PROJECT_FOLDER}") { // üîÅ Adjust per git repo
					bat 'mvn test -f pom.xml' 
				}
                
            }
        }
		stage('Stop Selenium Grid') {
		            steps {
		                script {
		                    echo "Stopping Selenium Grid and removing containers..."
		                    bat "docker compose -f ${COMPOSE_PATH}\\docker-compose.yml down" // Stop and remove containers
		                }
		            }
		 }
        stage('Publish Reports') {
            steps {
                publishHTML(target: [
                    reportDir: "${PROJECT_FOLDER}/src/test/resources/ExtentReport",  //üîÅ Adjust as per folder
                    reportFiles: 'ExtentReport.html',  
                    reportName: 'Extent Spark Report'
                ])
            }
        }
    }

    post {
        always {
            archiveArtifacts artifacts: "**/${PROJECT_FOLDER}/src/test/resources/ExtentReport/*.html", fingerprint: true
            junit "${PROJECT_FOLDER}/target/surefire-reports/*.xml"
            echo 'artifacts have been archived and test results published.'
        }
        
        success {
            echo 'The build was successful!'
            script {
				
				def htmlBody = readFile("${PROJECT_FOLDER}/src/main/resources/Email_Body_On_Successful.html")
				// Modify the href link in the "Email_Body_On_Successful.html" HTML body to point to the Jenkins build URL
				// href="http://localhost:8080/job/${JOB_NAME}/${BUILD_NUMBER}/artifact/***Givev project folder name***/src/test/resources/ExtentReport/ExtentReport.html"
				emailext(
				    to: "${EMAIL_TO}",
				    subject: "Build Success: ${env.JOB_NAME} #${env.BUILD_NUMBER}",
					body: htmlBody,
				    
				    mimeType: 'text/html',
				    attachLog: true,
				    attachmentsPattern: "${PROJECT_FOLDER}/logs/app.log" // üîÅ Adjust path as needed
					)
			
			}

        }
        
        failure {
            echo 'The build failed.'
        }
    }
}